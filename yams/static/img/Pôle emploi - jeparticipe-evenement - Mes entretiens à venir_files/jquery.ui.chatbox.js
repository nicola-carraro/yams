jQuery.noConflict();jQuery(function(a){});var chatId="";var chatUserName="";var chatTitle="";var ajouterMessageUrl="";var refreshMessageUrl="";var refreshStatusUrl="";var connexionUrl="";var deconnexionUrl="";var preHeight;var intervalRefreshMsg="";var intervalRefreshStatus="";function refreshMessages(){jQuery.ajax({type:"POST",url:refreshMessageUrl,accepts:"application/json; charset=utf-8",dataType:"json",success:function(c){var b=c;for(var a=0;a<b.length;a++){ajouterMessage(b[a])}}})}function initAutoRefresh(){intervalRefreshMsg=setInterval("refreshMessages()",2000);intervalRefreshStatus=setInterval("refreshStatus()",2000)}function ajouterMessage(a){jQuery("#chat_div").chatbox("option","boxManager").addMsgTo(recupererHeureEnvoi(a.time),chatTitle,a.message)}function refreshStatus(){var a={};if(jQuery("#uiChatboxTitle").hasClass("ui-icon-connected")){a.statutConnexion=true}jQuery.ajax({type:"POST",url:refreshStatusUrl,accepts:"application/json; charset=utf-8",dataType:"json",data:{chatStatut:JSON.stringify(a)},success:function(b){if(b&&b.hasOwnProperty("statutConnexion")){changerStatut()}},error:function(d,b,c){console.error("Erreur lors du refresh status",b);clearInterval(intervalRefreshMsg);clearInterval(intervalRefreshStatus)}})}function changerStatut(){jQuery("#chat_div").chatbox("option","boxManager").toggleStatus()}function recupererHeureEnvoi(c){var e;if(c){e=new Date(c)}else{e=new Date()}var b=e.getHours(),f=e.getMinutes(),a=e.getSeconds();return(b<10?"0":"")+b+(f<10?":0":":")+f+(a<10?":0":":")+a}(function(b){var a={};b.widget("ui.chatbox",{options:{id:null,title:null,user:null,hidden:false,offset:0,width:300,messageSent:function(e,c,d){this.boxManager.addMsgFrom(recupererHeureEnvoi(),c,d,0);a.message=d;a.fromUser=c;b.ajax({type:"POST",url:ajouterMessageUrl,accepts:"application/json; charset=utf-8",data:{chatMessage:JSON.stringify(a)},dataType:"json",success:function(h,f,g){},error:function(h,f,g){console.error("Erreur lors de l'envoi du message",f)}})},boxClosed:function(c){b.ajax({type:"POST",url:deconnexionUrl,accepts:"application/json; charset=utf-8",dataType:"json",success:function(f,d,e){clearInterval(intervalRefreshMsg);clearInterval(intervalRefreshStatus);window.location.reload(true)},error:function(f,d,e){console.error("Erreur lors de l'envoi du message",d)}})},boxManager:{init:function(c){this.elem=c},addMsgFrom:function(d,i,c){var l=this;var g=l.elem.uiChatboxLog;var h=document.createElement("div");g.append(h);b(h).hide();if(d){var j=document.createElement("span");b(j).text("["+d+"] ");b(j).addClass("ui-chatbox-msg-from");h.appendChild(j)}if(i){var f=document.createElement("span");b(f).text(i+": ");b(f).addClass("ui-chatbox-msg-from");h.appendChild(f)}var k=document.createElement("span");b(k).text(c);h.appendChild(k);b(h).addClass("ui-chatbox-msg");b(h).fadeIn();l._scrollToBottom()},addMsgTo:function(d,i,c){var l=this;var g=l.elem.uiChatboxLog;var h=document.createElement("div");g.append(h);b(h).hide();if(d){var j=document.createElement("span");b(j).text("["+d+"] ");b(j).addClass("ui-chatbox-msg-to");h.appendChild(j)}if(i){var f=document.createElement("span");b(f).text(i+": ");b(f).addClass("ui-chatbox-msg-to");h.appendChild(f)}var k=document.createElement("span");b(k).text(c);h.appendChild(k);b(h).addClass("ui-chatbox-msg");b(h).fadeIn();l._scrollToBottom()},addMsgAdmin:function(h){var d=this;var f=d.elem.uiChatboxLog;var g=document.createElement("div");f.append(g);b(g).hide();var c=document.createElement("span");b(c).text("["+recupererHeureEnvoi()+"] "+h);b(g).addClass("ui-chatbox-msg");b(c).addClass("ui-chatbox-msg-adm");g.appendChild(c);b(g).fadeIn();d._scrollToBottom()},highlightBox:function(){var c=this;c.elem.uiChatboxTitlebar.effect("highlight",{},300);c.elem.uiChatbox.effect("bounce",{times:3},300,function(){c.highlightLock=false;c._scrollToBottom()})},toggleBox:function(){this.elem.uiChatbox.toggle()},_scrollToBottom:function(){var c=this.elem.uiChatboxLog;c.scrollTop(c.get(0).scrollHeight)},toggleStatus:function(){if(this.elem.uiChatboxTitle.hasClass("ui-icon-connected")){this.elem.uiChatboxTitle.removeClass("ui-icon-connected").addClass("ui-icon-disconnected");this.addMsgAdmin(chatTitle+" déconnecté(e)")}else{this.elem.uiChatboxTitle.removeClass("ui-icon-disconnected").addClass("ui-icon-connected");this.addMsgAdmin(chatTitle+" connecté(e)")}}}},toggleContent:function(c){this.uiChatboxContent.toggle();if(this.uiChatboxContent.is(":visible")){b("#chatboxWindow").resizable();b("#chatboxWindow").css("min-height","250px").show();b("#chatboxWindow").css("height",preHeight+"px").show();b("#chatboxWindow").css("padding-bottom","100px").show();this.uiChatboxInputBox.focus()}else{b("#chatboxWindow").resizable("destroy");preHeight=b("#chatboxWindow").height();b("#chatboxWindow").css("min-height",b(".ui-chatbox-titlebar").height()+"px").show();b("#chatboxWindow").css("height",b(".ui-chatbox-titlebar").height()+"px").show();b("#chatboxWindow").css("padding-bottom","0px").show()}},widget:function(){return this.uiChatbox},_create:function(){var n=this,p=n.options,j=p.title||"No Title",h=(n.uiChatbox=b("<div></div>")).appendTo(document.body).addClass("ui-widget ui-corner-top ui-chatbox").attr("outline",0).attr("id","chatboxWindow").focusin(function(){}).focusout(function(){}),d=(n.uiChatboxTitlebar=b("<div></div>")).addClass("ui-widget-header ui-corner-top ui-chatbox-titlebar ui-dialog-header").appendTo(h),m=(n.uiChatboxTitle=b("<span></span>")).attr("id","uiChatboxTitle").addClass("ui-icon-disconnected").html(j).appendTo(d),e=(n.uiChatboxTitlebarClose=b('<a href="#"></a>')).addClass("ui-corner-all ui-chatbox-icon ").attr("role","button").hover(function(){e.addClass("ui-state-hover")},function(){e.removeClass("ui-state-hover")}).click(function(q){h.hide();n.options.boxClosed(n.options.id);return false}).appendTo(d),f=b("<span></span>").addClass("ui-icon ui-icon-closethick").text("close").appendTo(e),o=(n.uiChatboxTitlebarMinimize=b('<a href="#"></a>')).addClass("ui-corner-all ui-chatbox-icon").attr("role","button").hover(function(){o.addClass("ui-state-hover")},function(){o.removeClass("ui-state-hover")}).click(function(q){n.toggleContent(q);return false}).appendTo(d),i=b("<span></span>").addClass("ui-icon ui-icon-minusthick").text("minimize").appendTo(o),c=(n.uiChatboxContent=b("<div></div>")).addClass("ui-widget-content ui-chatbox-content ").appendTo(h),g=(n.uiChatboxLog=n.element).addClass("ui-widget-content ui-chatbox-log").appendTo(c),l=(n.uiChatboxInput=b("<div></div>")).addClass("ui-widget-content ui-chatbox-input").click(function(q){}).appendTo(c),k=(n.uiChatboxInputBox=b("<textarea></textarea>")).addClass("ui-widget-content ui-chatbox-input-box ui-corner-all").appendTo(l).keydown(function(q){if(q.keyCode&&q.keyCode==b.ui.keyCode.ENTER){msg=b.trim(b(this).val());if(msg.length>0){n.options.messageSent(n.options.id,n.options.user,msg)}b(this).val("");return false}}).focusin(function(){k.addClass("ui-chatbox-input-focus");var q=b(this).parent().prev();q.scrollTop(q.get(0).scrollHeight)}).focusout(function(){k.removeClass("ui-chatbox-input-focus")});d.find("*").add(d).disableSelection();c.children().click(function(){});n._setWidth(n.options.width);n._position(n.options.offset);n.options.boxManager.init(n);if(!n.options.hidden){h.show()}},_setOption:function(c,d){if(d!=null){switch(c){case"hidden":if(d){this.uiChatbox.hide()}else{this.uiChatbox.show()}break;case"offset":this._position(d);break;case"width":this._setWidth(d);break}}b.Widget.prototype._setOption.apply(this,arguments)},_setWidth:function(c){this.uiChatboxTitlebar.width(c+"px");this.uiChatboxLog.width(c+"px");this.uiChatboxInputBox.css("width",(c-18)+"px")},_position:function(c){this.uiChatbox.css("right",c)}});if(typeof Tapestry!="undefined"){b.extend(Tapestry.Initializer,{initParameters:function(d){var c=null;chatId=d.chatId;chatTitle=d.chatTitle;chatUserName=d.chatUserName;ajouterMessageUrl=d.ajouterMessageUrl;refreshMessageUrl=d.refreshMessageUrl;refreshStatusUrl=d.refreshStatusUrl;connexionUrl=d.connexionUrl;deconnexionUrl=d.deconnexionUrl;c=b("#chat_div").chatbox({id:chatId,title:chatTitle,user:chatUserName});b("#chatboxWindow").resizable();b("#chatboxWindow").draggable({handle:".ui-widget-header",containment:"document"});b("#chat_div").chatbox("option","boxManager").addMsgAdmin(chatTitle+" déconnecté(e)");clearInterval(intervalRefreshMsg);clearInterval(intervalRefreshStatus);if(c.is(":Visible")){b.ajax({type:"POST",url:connexionUrl,accepts:"application/json; charset=utf-8",dataType:"json",success:function(g,e,f){initAutoRefresh()},error:function(g,e,f){console.error("Erreur lors de la connexion",e)}})}}})}}(jQuery));